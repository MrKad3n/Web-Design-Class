<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Blacksmith - Kaden's Dungeon Game</title>
        <link rel="stylesheet" type="text/css" href="style.css">
        <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
        <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-blue.css">
        <style>
            .upgrade-container {
                display: none;
                padding: 20px;
                max-width: 1600px;
                margin: 0 auto;
            }

            .upgrade-container.active {
                display: block;
            }

            .party-equipment-grid {
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 20px;
                margin-bottom: 30px;
            }

            .member-column {
                background: rgba(15, 52, 96, 0.3);
                border: 2px solid #0f3460;
                border-radius: 10px;
                padding: 15px;
            }

            .member-name {
                text-align: center;
                font-size: 1.3em;
                color: #e94560;
                margin-bottom: 15px;
                font-weight: bold;
            }

            .member-level {
                text-align: center;
                font-size: 1em;
                color: #aaa;
                margin-bottom: 10px;
            }

            .equipment-slots {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .equip-slot {
                background: rgba(0, 0, 0, 0.4);
                border: 2px solid #555;
                border-radius: 8px;
                padding: 10px;
                cursor: pointer;
                transition: all 0.3s;
                min-height: 80px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            .equip-slot:hover {
                border-color: #e94560;
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(233, 69, 96, 0.3);
            }

            .equip-slot.empty {
                opacity: 0.5;
                cursor: default;
            }

            .equip-slot.empty:hover {
                border-color: #555;
                transform: none;
                box-shadow: none;
            }

            .slot-label {
                font-size: 0.85em;
                color: #888;
                margin-bottom: 5px;
            }

            .item-name {
                font-weight: bold;
                color: #fff;
                margin-bottom: 3px;
            }

            .item-level {
                font-size: 0.9em;
                color: #aaa;
            }

            .enchant-indicator {
                font-size: 0.85em;
                color: #ffcc00;
                margin-top: 5px;
            }

            .upgrade-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.85);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 3000;
                padding: 20px;
            }

            .upgrade-modal.active {
                display: flex;
            }

            .upgrade-modal-content {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                border: 3px solid #e94560;
                border-radius: 15px;
                padding: 30px;
                max-width: 600px;
                width: 100%;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
            }

            .upgrade-close {
                position: absolute;
                top: 15px;
                right: 15px;
                background: #e94560;
                color: #fff;
                border: none;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                font-size: 1.5em;
                cursor: pointer;
                font-weight: bold;
            }

            .upgrade-close:hover {
                background: #ff6b88;
            }

            .upgrade-header {
                text-align: center;
                margin-bottom: 25px;
            }

            .upgrade-header h2 {
                font-size: 2em;
                margin-bottom: 10px;
            }

            .upgrade-image {
                text-align: center;
                margin: 20px 0;
            }

            .upgrade-image img {
                max-width: 150px;
                max-height: 150px;
                border: 3px solid;
                border-radius: 10px;
                box-shadow: 0 0 20px currentColor;
            }

            .upgrade-info {
                background: rgba(15, 52, 96, 0.3);
                border: 2px solid #0f3460;
                border-radius: 10px;
                padding: 20px;
                margin-bottom: 20px;
            }

            .info-row {
                display: flex;
                justify-content: space-between;
                padding: 10px 0;
                border-bottom: 1px solid #0f3460;
            }

            .info-row:last-child {
                border-bottom: none;
            }

            .info-label {
                font-weight: bold;
                color: #aaa;
            }

            .info-value {
                color: #fff;
            }

            .upgrade-button {
                width: 100%;
                background: linear-gradient(135deg, #e94560 0%, #ff6b88 100%);
                color: #fff;
                border: 2px solid #fff;
                border-radius: 8px;
                padding: 15px 20px;
                font-size: 1.2em;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s;
                margin-top: 15px;
            }

            .upgrade-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(233, 69, 96, 0.5);
            }

            .enchant-section {
                background: rgba(255, 204, 0, 0.1);
                border: 2px solid #ffcc00;
                border-radius: 10px;
                padding: 15px;
                margin-top: 15px;
            }

            .enchant-title {
                color: #ffcc00;
                font-weight: bold;
                font-size: 1.2em;
                margin-bottom: 10px;
            }

            .no-enchant {
                color: #888;
                font-style: italic;
            }
        </style>
    </head>
<body id="blacksmith">
    <!-- Main Selection Screen -->
    <div class="w3-container w3-auto" id="selection-screen">
          
          <div class="w3-container w3-left" style="width:50%">
            <a href="home.html"><h2 class="glow">Back</h2></a>
        </div>
        
        <div class="w3-row">
            <div class="w3-col m4">
                <h2 class="glow clickable" onclick="craftClick()">Craft</h2>
                <img src="Assests/smelting.png" alt="img">
            </div>
            
            <div class="w3-col m4">
                <h2 class="glow clickable2" onclick="showUpgradeScreen()">Upgrade</h2>
                <img src="Assests/anvil.png" alt="img">
            </div>
            
            <div class="w3-col m4">
                <h2 class="glow clickable" onclick="showAttacksScreen()">Attacks</h2>
                <img src="Animations/gust/6.png" alt="img">
            </div>
        </div>
    </div>

    <!-- Upgrade Screen -->
    <div class="upgrade-container" id="upgrade-screen">
        <div class="w3-container w3-left" style="width:50%">
            <a href="#" onclick="hideUpgradeScreen(); return false;"><h2 class="glow">‚Üê Back</h2></a>
        </div>

        <h1 class="glow" style="text-align: center; margin: 20px 0;">Upgrade Equipment</h1>

        <div class="party-equipment-grid" id="party-equipment">
            <!-- Party member equipment will be rendered here -->
        </div>
    </div>

    <!-- Upgrade Modal -->
    <div class="upgrade-modal" id="upgrade-modal">
        <div class="upgrade-modal-content">
            <button class="upgrade-close" onclick="closeUpgradeModal()">√ó</button>
            <div id="upgrade-modal-body"></div>
        </div>
    </div>

    <footer>
        Kaden Cruts - 2025
    </footer>

    <script src="script.js"></script>
    <script>
        // Enchantment definitions
        const ENCHANTMENTS = {
            "Sharpness": {
                type: "attack_potency",
                description: "Increases attack damage by 15%",
                strBonus: 0.15,
                magBonus: 0.15
            },
            "Lifesteal": {
                type: "ability",
                description: "Grants Lifesteal ability - heal for 15% of damage dealt",
                abilityEffect: "leech"
            },
            "Burning": {
                type: "status_duration",
                description: "Burn status lasts 2 extra turns",
                statusType: "burn",
                durationBonus: 2
            },
            "Fortification": {
                type: "stat_boost",
                description: "+20 Defense",
                defense: 20
            },
            "Swiftness": {
                type: "stat_boost",
                description: "+15 Speed",
                speed: 15
            },
            "Vitality": {
                type: "stat_boost",
                description: "+50 Max Health",
                health: 50
            },
            "Hemorrhage": {
                type: "ability",
                description: "Grants Bleed ability - attacks apply bleed status",
                abilityEffect: "bleed"
            },
            "Precision": {
                type: "attack_potency",
                description: "Increases critical strike chance by 20%",
                critBonus: 0.20
            },
            "Arcane Power": {
                type: "stat_boost",
                description: "+25 Magic Power",
                magic: 25
            },
            "Berserker": {
                type: "stat_boost",
                description: "+25 Strength",
                strength: 25
            },
            // Basic Enchantments
            "Resilience": {
                type: "stat_boost",
                description: "+30 Max Health and +10 Defense",
                health: 30,
                defense: 10
            },
            "Haste": {
                type: "stat_boost",
                description: "+20 Speed",
                speed: 20
            },
            "Frost": {
                type: "status_effect",
                description: "Attacks apply chill status - reduces enemy speed",
                statusEffect: "chill"
            },
            "Vengeance": {
                type: "stat_boost",
                description: "+15 Strength and +15 Magic",
                strength: 15,
                magic: 15
            },
            "Warding": {
                type: "stat_boost",
                description: "+25 Defense",
                defense: 25
            },
            // Legendary Enchantments
            "Multistrike": {
                type: "ability",
                description: "üåü LEGENDARY: Grants MultiStrike ability - attack twice per turn",
                abilityEffect: "multistrike",
                legendary: true
            },
            "Soulrend": {
                type: "ability",
                description: "üåü LEGENDARY: Grants Grim ability - 50% chance to execute low HP enemies instantly",
                abilityEffect: "grim",
                legendary: true
            },
            "Phoenix Rebirth": {
                type: "ability",
                description: "üåü LEGENDARY: Once per battle, revive at 50% HP when defeated",
                abilityEffect: "phoenix",
                legendary: true
            },
            "Temporal Flux": {
                type: "ability",
                description: "üåü LEGENDARY: Grants Aftershock - immune to next attack after dealing damage (2 turn cooldown)",
                abilityEffect: "aftershock",
                legendary: true
            },
            "Chaos Storm": {
                type: "ability",
                description: "üåü LEGENDARY: Attacks apply random status effects and deal bonus chaos damage",
                abilityEffect: "chaos",
                legendary: true
            }
        };

        function craftClick() {
            alert("Crafting feature coming soon!");
        }

        function showUpgradeScreen() {
            document.getElementById('selection-screen').style.display = 'none';
            document.getElementById('upgrade-screen').classList.add('active');
            renderPartyEquipment();
        }

        function hideUpgradeScreen() {
            document.getElementById('selection-screen').style.display = 'block';
            document.getElementById('upgrade-screen').classList.remove('active');
        }

        function showAttacksScreen() {
            alert("Attacks management feature coming soon!");
        }

        function renderPartyEquipment() {
            const container = document.getElementById('party-equipment');
            if (!container) return;

            let html = '';
            const members = ['ONE', 'TWO', 'THREE', 'FOUR', 'FIVE'];
            const slotOrder = ['HELMET', 'CHEST', 'LEGS', 'BOOTS', 'MAINHAND', 'OFFHAND'];

            members.forEach(memberKey => {
                const member = PARTY_STATS[memberKey];
                if (!member) return;

                html += `
                    <div class="member-column">
                        <div class="member-name">${member.NAME}</div>
                        <div class="member-level">Level ${member.LEVEL || 1}</div>
                        <div class="equipment-slots">
                `;

                slotOrder.forEach(slot => {
                    const itemName = member[slot];
                    
                    if (itemName && itemName !== null) {
                        const item = INVENTORY.find(i => i.name === itemName);
                        if (item) {
                            const rarity = item.rarity || 'Common';
                            const color = getRarityColor(rarity);
                            const enchant = item.enchant || null;
                            let enchantDisplay = '';
                            if (enchant) {
                                const isLegendary = ['Multistrike', 'Soulrend', 'Phoenix Rebirth', 'Temporal Flux', 'Chaos Storm'].includes(enchant);
                                const enchantColor = isLegendary ? '#ff8000' : '#ffcc00';
                                const icon = isLegendary ? 'üåü' : '‚ú®';
                                enchantDisplay = `<div class="enchant-indicator" style="color: ${enchantColor};">${icon} ${enchant}</div>`;
                            }

                            html += `
                                <div class="equip-slot" style="border-color: ${color};" 
                                     onclick="showUpgradeModal('${memberKey}', '${slot}', '${itemName}')">
                                    <div class="slot-label">${slot}</div>
                                    <div class="item-name" style="color: ${color};">${itemName}</div>
                                    <div class="item-level">Level ${item.level || 1}</div>
                                    ${enchantDisplay}
                                </div>
                            `;
                        } else {
                            html += `
                                <div class="equip-slot empty">
                                    <div class="slot-label">${slot}</div>
                                    <div style="color: #666; text-align: center;">Empty</div>
                                </div>
                            `;
                        }
                    } else {
                        html += `
                            <div class="equip-slot empty">
                                <div class="slot-label">${slot}</div>
                                <div style="color: #666; text-align: center;">Empty</div>
                            </div>
                        `;
                    }
                });

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function showUpgradeModal(memberKey, slot, itemName) {
            const modal = document.getElementById('upgrade-modal');
            const modalBody = document.getElementById('upgrade-modal-body');
            if (!modal || !modalBody) return;

            const item = INVENTORY.find(i => i.name === itemName);
            if (!item) return;

            const member = PARTY_STATS[memberKey];
            const rarity = item.rarity || 'Common';
            const color = getRarityColor(rarity);
            const enchant = item.enchant || null;
            const enchantData = enchant ? ENCHANTMENTS[enchant] : null;

            let html = `
                <div class="upgrade-header">
                    <h2 style="color: ${color};">${itemName}</h2>
                    <div style="color: #aaa;">Equipped by ${member.NAME} - ${slot}</div>
                </div>

                <div class="upgrade-image">
                    <img src="${item.image || 'Assests/empty-slot.png'}" 
                         alt="${itemName}"
                         style="border-color: ${color};">
                </div>

                <div class="upgrade-info">
                    <div class="info-row">
                        <span class="info-label">Level:</span>
                        <span class="info-value">${item.level || 1}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Rarity:</span>
                        <span class="info-value" style="color: ${color};">${rarity}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Strength:</span>
                        <span class="info-value">${item.strength || 0}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Magic:</span>
                        <span class="info-value">${item.magic || 0}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Speed:</span>
                        <span class="info-value">${item.speed || 0}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Defense:</span>
                        <span class="info-value">${item.defense || 0}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Health:</span>
                        <span class="info-value">${item.health || 0}</span>
                    </div>
                </div>

                <button class="upgrade-button" onclick="upgradeItemLevel('${itemName}')">
                    ‚¨ÜÔ∏è Upgrade Level (Coming Soon)
                </button>
            `;

            if (enchant && enchantData) {
                const isLegendary = enchantData.legendary || false;
                const enchantColor = isLegendary ? '#ff8000' : '#ffcc00';
                const borderColor = isLegendary ? '#ff8000' : '#ffcc00';
                const icon = isLegendary ? 'üåü' : '‚ú®';
                html += `
                    <div class="enchant-section" style="cursor: pointer; border-color: ${borderColor}; background: ${isLegendary ? 'rgba(255, 128, 0, 0.1)' : 'rgba(255, 204, 0, 0.1)'};" onclick="showEnchantOptions('${itemName}')">
                        <div class="enchant-title" style="color: ${enchantColor};">${icon} Enchantment: ${enchant}</div>
                        <div style="color: #fff; margin-top: 10px;">${enchantData.description}</div>
                        <div style="color: #aaa; margin-top: 10px; font-size: 0.9em;">Click to replace enchantment</div>
                    </div>
                `;
            } else {
                html += `
                    <div class="enchant-section" style="cursor: pointer;" onclick="showEnchantOptions('${itemName}')">
                        <div class="enchant-title">‚ú® Enchantment</div>
                        <div class="no-enchant">No enchantment applied</div>
                        <div style="color: #aaa; margin-top: 10px; font-size: 0.9em;">Click to apply enchantment</div>
                    </div>
                `;
            }

            modalBody.innerHTML = html;
            modal.classList.add('active');
        }

        function showEnchantOptions(itemName) {
            const item = INVENTORY.find(i => i.name === itemName);
            if (!item) return;

            // Get available enchantments
            const enchantInventory = typeof ENCHANTMENT_INVENTORY !== 'undefined' ? ENCHANTMENT_INVENTORY : {};
            const availableEnchants = Object.keys(enchantInventory).filter(e => enchantInventory[e] > 0);

            if (availableEnchants.length === 0) {
                alert("You don't have any enchantments! Obtain enchantments from battles and explore the world.");
                return;
            }

            // Build enchantment selection modal
            let html = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="color: #ffcc00;">Select Enchantment</h2>
                    <div style="color: #aaa; margin-top: 10px;">Choose an enchantment to apply to ${itemName}</div>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
            `;

            availableEnchants.forEach(enchantName => {
                const count = enchantInventory[enchantName];
                const enchantData = ENCHANTMENTS[enchantName];
                const isLegendary = enchantData.legendary || false;
                const borderColor = isLegendary ? '#ff8000' : '#ffcc00';
                const bgColor = isLegendary ? 'rgba(255, 128, 0, 0.1)' : 'rgba(255, 204, 0, 0.1)';
                const hoverBgColor = isLegendary ? 'rgba(255, 128, 0, 0.2)' : 'rgba(255, 204, 0, 0.2)';
                const icon = isLegendary ? 'üåü' : '‚ú®';
                
                html += `
                    <div style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;"
                         onmouseover="this.style.background='${hoverBgColor}'; this.style.transform='translateX(5px)';"
                         onmouseout="this.style.background='${bgColor}'; this.style.transform='translateX(0)';"
                         onclick="applyEnchantment('${itemName}', '${enchantName}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="color: ${borderColor}; font-weight: bold; font-size: 1.1em;">${icon} ${enchantName}</div>
                                <div style="color: #fff; margin-top: 5px;">${enchantData.description}</div>
                            </div>
                            <div style="background: rgba(233, 69, 96, 0.8); color: #fff; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2em;">
                                ${count}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                </div>
                <button class="upgrade-button" onclick="showUpgradeModal('${item.equipped ? getEquippedMemberKey(itemName) : 'ONE'}', '${item.slot}', '${itemName}')" style="background: linear-gradient(135deg, #666 0%, #444 100%);">
                    ‚Üê Back to Item
                </button>
            `;

            const modalBody = document.getElementById('upgrade-modal-body');
            if (modalBody) {
                modalBody.innerHTML = html;
            }
        }

        function getEquippedMemberKey(itemName) {
            for (const memberKey in PARTY_STATS) {
                const member = PARTY_STATS[memberKey];
                for (const slot of ['HELMET', 'CHEST', 'LEGS', 'BOOTS', 'MAINHAND', 'OFFHAND']) {
                    if (member[slot] === itemName) {
                        return memberKey;
                    }
                }
            }
            return 'ONE';
        }

        function applyEnchantment(itemName, enchantName) {
            const item = INVENTORY.find(i => i.name === itemName);
            if (!item) return;

            // Check if item already has an enchantment
            if (item.enchant && item.enchant !== enchantName) {
                if (!confirm(`This item already has ${item.enchant} enchantment. Replace it with ${enchantName}? (Previous enchantment will be lost)`)) {
                    return;
                }
            }

            // Remove enchantment from inventory
            if (typeof removeEnchantment === 'function') {
                if (!removeEnchantment(enchantName, 1)) {
                    alert("Failed to apply enchantment!");
                    return;
                }
            } else {
                alert("Enchantment system not loaded properly!");
                return;
            }

            // Apply enchantment to item
            item.enchant = enchantName;

            // Save game data
            if (typeof saveGameData === 'function') {
                saveGameData();
            }

            // Update display
            renderPartyEquipment();
            
            // Show success message and return to item view
            alert(`Successfully applied ${enchantName} to ${itemName}!`);
            
            // Find which member has this item equipped
            const memberKey = getEquippedMemberKey(itemName);
            const slot = item.slot || 'MAINHAND';
            showUpgradeModal(memberKey, slot, itemName);
        }

        function closeUpgradeModal() {
            const modal = document.getElementById('upgrade-modal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function upgradeItemLevel(itemName) {
            alert("Item upgrade functionality coming soon!");
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('upgrade-modal');
            if (e.target === modal) {
                closeUpgradeModal();
            }
        });
    </script>
</body>
</html>