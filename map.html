<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Grid Map</title>
  <link rel="stylesheet" href="map.css">
</head>
<body id="loading">
  <div class="w3-container w3-left" style="position:fixed;top:20px;left:20px;z-index:10000;background:rgba(0,0,0,0.7);padding:15px;border-radius:10px;backdrop-filter:blur(5px);">

    <a href="select.html"><span class="glow">Back</span></a>
    <button id="returnToMain" onclick="returnToMainPath()" style="display:none;margin-left:20px;background:rgba(255,165,0,0.9);color:white;border:2px solid rgba(255,140,0,1);padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:14px;">
      ‚Üê Return to Main Path
    </button>

</div>
  <div id="map-container">
    <div id="map"></div>
  </div>

  <div id="popup" class="hidden">
    <div id="popup-content">
        <div id="level-info">
            level: # TYPE dungeon
        </div>
        <div id="enemy-list">
            <img id="Enemy One" src="Enemies/skull.png" alt="Skull Enemy">
            <img id="Enemy Two" src="Enemies/skull.png" alt="Skull Enemy">
            <img id="Enemy Three" src="Enemies/skull.png" alt="Skull Enemy">
        </div>
        <div id="num-enemies">
            # enemies
        </div>
        
    </div>
    
  </div>

  <script src="script.js"></script>
  
  <!-- Debug/Test Buttons -->
  <div style="position:fixed;bottom:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px;">
    <button onclick="skipNextLevel()" style="background:rgba(255,165,0,0.9);color:white;border:2px solid rgba(255,140,0,1);padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:14px;box-shadow:0 4px 8px rgba(0,0,0,0.3);">
      Skip Next Level (Test)
    </button>
    <button onclick="skipToLevel100()" style="background:rgba(255,0,0,0.9);color:white;border:2px solid rgba(200,0,0,1);padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:14px;box-shadow:0 4px 8px rgba(0,0,0,0.3);">
      Skip to Level 100 (Test)
    </button>
  </div>
  
  <script>
    // Music system for map page
    let mapMusic = null;
    
    function playMapMusic() {
      const musicEnabled = localStorage.getItem('musicEnabled') === 'true';
      if (!musicEnabled) return;
      
      if (mapMusic) {
        mapMusic.pause();
        mapMusic = null;
      }
      
      mapMusic = new Audio('audio/background/mapMusic.mp3');
      mapMusic.loop = true;
      mapMusic.volume = 0.5;
      
      // Restore playback position from localStorage
      const savedPosition = parseFloat(localStorage.getItem('mapMusic_position')) || 0;
      mapMusic.currentTime = savedPosition;
      
      // Save position periodically
      mapMusic.addEventListener('timeupdate', () => {
        localStorage.setItem('mapMusic_position', mapMusic.currentTime.toString());
      });
      
      const playPromise = mapMusic.play();
      if (playPromise !== undefined) {
        playPromise.then(() => {
          console.log('Map music playing');
        }).catch(err => {
          console.log('Autoplay prevented, waiting for user interaction:', err);
          const startMusic = () => {
            if (mapMusic && localStorage.getItem('musicEnabled') === 'true') {
              mapMusic.play().catch(e => console.error('Failed to play music:', e));
              document.removeEventListener('click', startMusic);
              document.removeEventListener('keydown', startMusic);
            }
          };
          document.addEventListener('click', startMusic);
          document.addEventListener('keydown', startMusic);
        });
      }
    }
    
    // Start music when page loads
    window.addEventListener('DOMContentLoaded', () => {
      playMapMusic();
    });
    
    function skipNextLevel() {
      // Load progression to find next locked level
      const progression = window.loadDungeonProgression ? window.loadDungeonProgression() : { unlockedUpToLevel: 1 };
      const nextLevel = progression.unlockedUpToLevel;
      
      if (nextLevel <= 100) {
        // Unlock the level using the global function
        if (typeof window.clearLevelAndUnlock === 'function') {
          window.clearLevelAndUnlock(nextLevel);
          alert(`Level ${nextLevel} completed and Level ${nextLevel + 1} unlocked!`);
          
          // Refresh the map display
          if (typeof renderGrid === 'function') {
            renderGrid();
          } else {
            // Fallback: reload the page
            window.location.reload();
          }
        } else {
          alert('Unable to unlock level. clearLevelAndUnlock function not found.');
          console.error('window.clearLevelAndUnlock is not available');
        }
      } else {
        alert('All levels already unlocked!');
      }
    }
    
    function skipToLevel100() {
      // Skip all levels from 1 to 99
      if (typeof window.clearLevelAndUnlock === 'function') {
        // Clear levels 1-99
        for (let i = 1; i < 100; i++) {
          window.clearLevelAndUnlock(i);
        }
        alert('Levels 1-99 completed! Level 100 unlocked!');
        
        // Refresh the map display
        if (typeof renderGrid === 'function') {
          renderGrid();
        } else {
          // Fallback: reload the page
          window.location.reload();
        }
      } else {
        alert('Unable to unlock levels. clearLevelAndUnlock function not found.');
        console.error('window.clearLevelAndUnlock is not available');
      }
    }
  </script>
</body>
</html>